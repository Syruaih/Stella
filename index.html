<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Galerie Orbitale — + Codex</title>
<style>
  :root{
    --move-duration:.6s;
    --line-duration:.6s;
    --pop-shadow:0 10px 30px rgba(0,0,0,.45);

    --accent:#48cae4; --accent-2:#00b4d8; --accent-3:#a3d9ff;
    --pane:#0f1828; --pane-2:#0b1422; --pane-3:#0a1220;
    --border:rgba(72,202,228,.28); --glow:rgba(72,202,228,.65);
    --text:#e9f7ff; --text-dim:rgba(233,247,255,.8);

    /* === Nouveaux tags (overridés par le thème) === */
    --tag-love:#c026d3;      /* Amours */
    --tag-important:#16a34a; /* Important */
    --tag-friend:#3b82f6;    /* Ami */
    --tag-rival:#f97316;     /* Rival */
    --tag-enemy:#ef4444;     /* Ennemie */
    --tag-unknown:#6b7280;   /* ??? */

    --fx-duration:.28s; --fx-ease:cubic-bezier(.2,.6,.2,1); --fx-translate:4px;

    --title-line: clamp(28px, 2.2vw, 36px);
    --tip-line: 1.35em;
    --title-gap: 6px;
    --tip-lines: 1;
    --titleBlockH: calc(var(--title-line) + var(--title-gap) + var(--tip-lines)*var(--tip-line));

    --center-fade: .36s;
  }

  html, body { height:100%; }
  body{
    font-family:"Poppins",sans-serif;margin:0;color:var(--text);
    background:radial-gradient(ellipse at bottom,#0d1b2a 0%,#000 100%);
    height:100%; overflow:hidden; display:flex; flex-direction:column;
  }
  body.has-bg { background:none; }

  .text-smooth, .text-smooth *{
    transition:
      color var(--fx-duration) var(--fx-ease),
      background-color var(--fx-duration) var(--fx-ease),
      border-color var(--fx-duration) var(--fx-ease),
      box-shadow var(--fx-duration) var(--fx-ease),
      opacity var(--fx-duration) var(--fx-ease),
      transform var(--fx-duration) var(--fx-ease);
  }
  .fx-reveal{ opacity:0; transform:translateY(var(--fx-translate)); }
  .fx-reveal.is-in{ opacity:1; transform:translateY(0); }
  .fx-swap{ opacity:1; }
  .fx-swap.is-changing{ opacity:0; }

  @media (prefers-reduced-motion: reduce){
    :root{ --fx-duration:0s; --fx-translate:0; }
    .text-smooth, .fx-reveal, .fx-swap{ transition:none !important; transform:none !important; }
  }

  .bg{ position:fixed; inset:0; background:center/cover no-repeat; filter:blur(48px); transform:scale(1.08); z-index:-3; opacity:1; transition:opacity .5s ease; }
  .bg.is-fading{ opacity:0; }
  .stars{position:fixed;inset:0;background:transparent url('https://www.transparenttextures.com/patterns/stardust.png') repeat;z-index:-1;opacity:.5; mix-blend-mode:screen;}
  body.has-bg .stars { display:none; }

  /* ===== TOP BAR ===== */
  .topBar{
    background:var(--pane);
    border-bottom:1px solid var(--border);
    padding:14px;
    display:flex; flex-direction:column; gap:12px;
    flex:0 0 auto; position:relative;
  }
  .viewTabs{ display:flex; gap:8px; justify-content:center; }
  .viewTab{
    background:var(--pane);
    color:var(--text);
    border:1px solid var(--border);
    padding:8px 12px; border-radius:10px; cursor:pointer;
  }
  .viewTab[aria-selected="true"], .viewTab:hover{ box-shadow:0 0 12px var(--glow); background:var(--pane-3); }

  .topBar .tip{
    margin:0; line-height: var(--tip-line);
    height: calc(var(--tip-lines)*var(--tip-line));
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    color:var(--text-dim); text-align:center; font-size:.92em;
  }
  .headRow.headRow--center{
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px; padding-right:56px;
  }
  .headRow--center .titleGroup{
    justify-self:center; display:flex; flex-direction:column; align-items:center; gap: var(--title-gap);
    height: var(--titleBlockH); overflow:hidden;
  }
  .headRow--center .searchWrap{ justify-self:end; }
  .headRow--center .ghost{ height:1px; opacity:0; }

  .topTitleText{ color:var(--text); font-size: clamp(1.2rem, 1.2rem + 0.6vw, 2rem); font-weight:700; letter-spacing:.2px; line-height:1.1; text-shadow:none; }

  .topActions{ position:absolute; right:12px; top:12px; display:flex; gap:8px; }
  .iconBtn{
    background:var(--pane); color:var(--text); border:1px solid var(--border); border-radius:10px;
    padding:8px 10px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.25);
  }
  .iconBtn:hover{ background:var(--pane-3); box-shadow:0 0 12px var(--glow); }

  .searchWrap{display:flex;align-items:center;gap:8px}
  .searchWrap input{
    width:min(44vw,380px);
    border:1px solid var(--border); border-radius:10px; padding:8px 10px;
    background:linear-gradient(180deg,var(--pane-2),var(--pane));
    color:var(--text);
    outline:none; box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);
  }
  .searchWrap input::placeholder{color:var(--text-dim);} 

  /* ===== LAYOUT ===== */
  .shell{flex:1; display:flex; min-height:0; height:100%;}
  .leftPane{position:relative; flex:1; min-width:0; display:flex; align-items:center; justify-content:center; padding:8px;}
  .rightPane{
    width:360px; max-width:42vw; min-width:280px; flex:0 0 auto; height:100%; align-self:stretch;
    background:var(--pane); border-left:1px solid var(--border);
    display:flex; flex-direction:column; padding:14px; gap:12px; overflow:auto;
  }
  @media (max-width: 900px){
    .shell{flex-direction:column; height:auto;}
    .rightPane{width:100% !important; max-width:none !important; border-left:none; border-top:1px solid var(--border); height:auto; align-self:auto;}
    .topBar{border-bottom:1px solid var(--border);} 
  }

  /* ===== OVERLAY NOTES ===== */
  .leftOverlay{ position:absolute; top:10px; left:10px; z-index:6; display:flex; flex-direction:column; gap:6px; max-width:min(44vw,520px); pointer-events:none; }
  .overlayCard{ pointer-events:auto; background:transparent; border:none; box-shadow:none; padding:0; margin:0; }
  #leftNote{ width:100%; min-height:120px; resize:vertical; border-radius:0; padding:0; line-height:1.5; border:none; outline:none; background:transparent; color:var(--text); caret-color:var(--accent-3); text-shadow:0 0 8px var(--glow), 0 0 14px rgba(0,0,0,.25); }
  #leftNote::placeholder{ color:var(--text-dim); text-shadow:0 0 8px rgba(0,0,0,.25); }
  .overlayBtns{display:flex; gap:8px; flex-wrap:wrap; opacity:0; pointer-events:none; transition:.2s; margin-top:4px;}
  .overlayBtn{ background:var(--pane); color:var(--text); border:1px solid var(--border); padding:6px 10px; border-radius:8px; cursor:pointer; }
  .overlayBtn:hover{ background:var(--pane-3); box-shadow:0 0 8px var(--glow); }
  .overlayCard:focus-within .overlayBtns{ opacity:1; pointer-events:auto; }

  /* ===== ORBIT VIEW ===== */
  .gallery{display:flex;justify-content:center;align-items:flex-start;flex-wrap:wrap;gap:28px 36px;max-width:1100px;padding:8px 10px;transition:opacity .28s ease;}
  .gallery.is-fading{opacity:0; pointer-events:none;}
  .card{display:flex;flex-direction:column;align-items:center;gap:8px;width:200px}
  .card img{width:180px;height:180px;object-fit:cover;border-radius:50%;cursor:pointer;box-shadow:0 0 25px var(--glow);transition:transform .3s,box-shadow .3s;}
  .card img:hover{transform:scale(1.08);box-shadow:0 0 30px var(--accent-2),0 0 60px var(--accent);} 
  .label{font-size:.95em;opacity:.9}

  .orbit-stage{position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center;}
  .orbit-container{ position:absolute; inset:0; width:100%; height:100%; max-width:none !important; max-height:none; overflow:visible; display:none; opacity:0; transform:translateY(6px) scale(.985); transition:opacity .28s ease, transform .28s ease; }
  .orbit-container.active{display:block;}
  .orbit-container.is-visible{opacity:1; transform:translateY(0) scale(1);} 

  .line-layer{position:absolute;inset:0;pointer-events:none;z-index:1;}
  .connector{position:absolute;height:2px;opacity:0;transform-origin:0 50%;transition: width var(--line-duration) ease, opacity .2s ease;}

  .orbit-center-wrap{ position:absolute; top:50%; left:50%; width:180px; height:180px; transform:translate(-50%, -50%); z-index:10; }
  .orbit-center-wrap .orbit-center{ position:absolute; inset:0; width:100%; height:100%; border-radius:50%; object-fit:cover; box-shadow:0 0 25px var(--accent); transition: opacity var(--center-fade) ease, transform var(--center-fade) ease; will-change: opacity, transform; backface-visibility: hidden; contain: paint; opacity:1; cursor:pointer; }
  .orbit-center-wrap .orbit-center.is-hidden{ opacity:0; }
  .orbit-center-wrap.is-swapping .orbit-center:not(.is-hidden){ transform:translateY(-1px) scale(.995); }

  .orbit-item{position:absolute;width:120px;height:120px;border-radius:50%;object-fit:cover;opacity:0;transition:top var(--move-duration) ease,left var(--move-duration) ease,opacity .3s ease;cursor:pointer;z-index:2;}

  .orbit-container.hide-edges .orbit-item,
  .orbit-container.hide-edges .connector{ opacity: 0 !important; transition: opacity .12s ease !important; pointer-events: none; }

  .sideTitle{display:flex;align-items:center;gap:10px;}
  .swatch{width:12px;height:12px;border-radius:50%;box-shadow:0 0 8px currentColor;}
  .noteHead{font-weight:600;font-size:1.05em;color:var(--accent-3)}
  .noteLabel{font-size:.85em;color:var(--text-dim);margin-top:-4px}
  textarea{width:100%; min-height:220px; resize:vertical; border-radius:12px; padding:12px 14px; line-height:1.5; border:1px solid var(--border); background:linear-gradient(180deg,var(--pane-2),var(--pane)); color:var(--text); outline:none; box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);}  
  .btnRow{display:flex;gap:8px;flex-wrap:wrap}
  .btn{ background:var(--pane); color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn:hover{background:var(--pane-3); box-shadow:0 0 12px var(--glow);}  
  .satList{display:flex;flex-direction:column;gap:8px; max-height:38vh; overflow:auto; padding-right:4px;}
  .satItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:rgba(11,20,34,.8);transition:transform .12s ease, box-shadow .12s ease;}
  .satItem:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.25); }
  .satLeft{display:flex;align-items:center;gap:10px;}
  .dot{width:10px;height:10px;border-radius:999px;box-shadow:0 0 8px currentColor;}
  .satName{font-weight:600;}
  .satTag{opacity:.85;font-size:.9em;}

  .popover{ position:absolute; z-index:20; min-width:300px; max-width:420px; white-space:normal; background:var(--pane-2); border:1px solid var(--border); border-radius:12px; padding:12px 14px; box-shadow:var(--pop-shadow); }
  .popover[data-state="hidden"]{ opacity:0; transform:translate3d(var(--from-x,0),var(--from-y,0),0) scale(.98); pointer-events:none; }
  .popover[data-state="shown"]{ opacity:1; transform:translate3d(0,0,0) scale(1); transition:opacity .25s ease, transform .25s ease; }
  .popover .popTitle{ font-weight:600; margin-bottom:6px; font-size:.95em; color:var(--accent-3); }
  .popover .popText{  font-size:.95em; line-height:1.4; white-space:pre-wrap; color:var(--text); }
  .popover .popActions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .popover .popBtn{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--pane); color:var(--text); cursor:pointer; }
  .popover .popBtn:hover{ background:var(--pane-3); box-shadow:0 0 8px var(--glow); }
  .popover .popEdit{ display:none; width:100%; min-height:120px; border-radius:8px; padding:8px; border:1px solid var(--border); background:var(--pane); color:var(--text); }

  .settingsOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(2px); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:100; }
  .settingsOverlay[aria-hidden="false"]{ opacity:1; pointer-events:auto; }
  .settingsPanel{ position:fixed; top:0; right:0; height:100%; width:min(480px, 92vw); transform: translateX(105%); transition: transform .25s ease; z-index:101; display:flex; align-items:stretch; }
  .settingsPanel[aria-hidden="false"]{ transform: translateX(0); }
  .settingsCard{ background:var(--pane); border-left:1px solid var(--border); width:100%; height:100%; display:flex; flex-direction:column; gap:12px; box-shadow: -12px 0 30px rgba(0,0,0,.35); }
  .settingsHead{ display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid var(--border); }
  .settingsHead h2{ margin:0; font-size:1.2rem; color:var(--accent-3); }
  .tabs{ display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid var(--border); }
  .tabBtn{ background:var(--pane); color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:8px; cursor:pointer; }
  .tabBtn.active, .tabBtn:hover{ box-shadow:0 0 10px var(--glow); }
  .tabPanes{ padding:12px; overflow:auto; }
  .tabPane{ display:none; } .tabPane.active{ display:block; }
  .tabHint{ color:var(--text-dim); margin-top:-4px; margin-bottom:10px; }

  .bgPicker{ display:grid; grid-template-columns:repeat(auto-fill, minmax(90px,1fr)); gap:10px; padding:4px 0; }
  .bgThumb{ width:100%; height:60px; border-radius:10px; overflow:hidden; border:1px solid var(--border); cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.25); transition:transform .15s ease, box-shadow .15s ease, border-color .15s; background:var(--pane); }
  .bgThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .bgThumb:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.35); }
  .bgThumb.active{ border-color:var(--accent); box-shadow:0 0 12px var(--glow); }

  /* ===== Local Orbit nav buttons ===== */
  .stageBtns{ position:absolute; top:10px; right:10px; z-index:15; display:none; gap:8px; }
  .stageBtn{ background:var(--pane); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.25); }
  .stageBtn:hover{ background:var(--pane-3); box-shadow:0 0 12px var(--glow); }

  /* ===== CODEX (nouvelle partie) ===== */
  .codex{ display:none; width:100%; height:100%; }
  .codex.active{ display:flex; gap:16px; padding:12px; }
  .codex .filters{ width:280px; max-width:32vw; flex:0 0 auto; background:var(--pane); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.25); }
  .codex .filters h3{ margin:0 0 8px; color:var(--accent-3); font-size:1rem; }
  .codex .filterRow{ display:flex; gap:8px; flex-wrap:wrap; }
  .codex .chip{ border:1px solid var(--border); background:var(--pane-2); color:var(--text); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:.9em; }
  .codex .chip[aria-pressed="true"]{ box-shadow:0 0 12px var(--glow); background:var(--pane-3); }
  .codex .searchBox{ margin-top:10px; display:flex; gap:8px; }
  .codex .searchBox input{ flex:1; border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:linear-gradient(180deg,var(--pane-2),var(--pane)); color:var(--text); }
  .codex .sortRow{ margin-top:10px; display:flex; gap:8px; align-items:center; }
  .codex .sortRow select{ flex:1; border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:linear-gradient(180deg,var(--pane-2),var(--pane)); color:var(--text); }

  .codex .grid{ flex:1; min-width:0; display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; overflow:auto; padding-right:4px; }
  .codexCard{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:rgba(11,20,34,.75); box-shadow:0 6px 16px rgba(0,0,0,.25); display:flex; flex-direction:column; }
  .codexCard .thumb{ width:100%; aspect-ratio: 4/3; object-fit:cover; display:block; }
  .codexCard .body{ padding:10px 12px; display:flex; flex-direction:column; gap:4px; }
  .codexCard h4{ margin:0; font-size:1rem; }
  .codexCard .meta{ font-size:.85em; color:var(--text-dim); }
  .codexCard .tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .tagDot{ width:8px; height:8px; border-radius:50%; box-shadow:0 0 6px currentColor; display:inline-block; vertical-align:middle; margin-right:6px; }
  .codexCard .actions{ margin-top:8px; display:flex; gap:8px; }

  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:200; }
  .modal[aria-hidden="false"]{ display:flex; }
  .modalCard{ width:min(900px, 92vw); max-height:88vh; overflow:auto; background:var(--pane); border:1px solid var(--border); border-radius:14px; box-shadow:0 14px 40px rgba(0,0,0,.45); }
  .modalHead{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border); }
  .modalBody{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:12px; }
  .modalBody img{ width:100%; aspect-ratio: 4/3; object-fit:cover; border-radius:10px; box-shadow:0 0 18px var(--glow); }
  .modalBody textarea{ min-height:180px; }
  @media (max-width: 900px){ .modalBody{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="bg" id="bg"></div>
  <div class="stars"></div>

  <div class="topBar text-smooth">
    <div class="viewTabs" role="tablist" aria-label="Changer de partie">
      <button class="viewTab" id="tab-orbit" role="tab" aria-selected="true" data-view="orbit">🪐 Orbite</button>
      <button class="viewTab" id="tab-codex" role="tab" aria-selected="false" data-view="codex">📚 Codex</button>
    </div>

    <div class="headRow headRow--center">
      <div class="ghost"></div>
      <div class="titleGroup">
        <div id="topTitle" class="topTitleText fx-swap">Aucune image sélectionnée</div>
        <p id="topTip" class="tip fx-swap">
          Clique un centre pour voir ses satellites. Clique un <b>satellite</b> pour ouvrir la note « centre → satellite ».
        </p>
      </div>
      <div class="searchWrap" id="searchWrap">
        <form id="searchForm" role="search" aria-label="Changer l'image centrale" autocomplete="off">
          <input id="imgSearch" list="imgList" placeholder="Rechercher (ex: Galaxie, Lune…)" />
          <datalist id="imgList"></datalist>
          <button class="iconBtn" type="submit" title="Mettre au centre">🔎</button>
        </form>
      </div>
    </div>
    <div class="topActions">
      <button id="openSettings" class="iconBtn" aria-haspopup="dialog" aria-controls="settingsPanel" aria-expanded="false" title="Paramètres">⚙️</button>
    </div>
  </div>

  <div class="shell text-smooth">
    <div class="leftPane">
      <!-- NOTES FLOTTANTES -->
      <div class="leftOverlay" aria-live="polite">
        <div class="overlayCard fx-reveal">
          <textarea id="leftNote" placeholder="Notes (globales)…"></textarea>
          <div class="overlayBtns">
            <button class="overlayBtn" id="leftNoteSave">💾 Enregistrer</button>
            <button class="overlayBtn" id="leftNoteClear">🧹 Effacer</button>
          </div>
        </div>
      </div>

      <!-- ===== VUE ORBITE ===== -->
      <div class="orbit-stage" id="view-orbit" aria-labelledby="tab-orbit">
        <div class="gallery fx-reveal" id="mainGallery"></div>
        <div id="orbitContainer" class="orbit-container" aria-live="polite">
          <div id="lineLayer" class="line-layer"></div>
          <div id="orbitCenterWrap" class="orbit-center-wrap" data-name="">
            <img id="orbitCenterA" class="orbit-center" alt="Centre A">
            <img id="orbitCenterB" class="orbit-center is-hidden" alt="Centre B">
          </div>
        </div>
        <div class="stageBtns" id="stageBtns">
          <button id="stepBackBtn" class="stageBtn" title="Retour d’un niveau">↩︎</button>
          <button id="homeBtn" class="stageBtn" title="Retour à l’accueil">🏠</button>
        </div>
      </div>

      <!-- ===== VUE CODEX ===== -->
      <section class="codex" id="view-codex" aria-labelledby="tab-codex" aria-hidden="true">
        <aside class="filters">
          <h3>Filtres</h3>
          <div class="filterRow" id="tagChips"></div>
          <div class="searchBox">
            <input id="codexSearch" placeholder="Rechercher un nom…" />
          </div>
          <div class="sortRow">
            <label for="codexSort">Trier</label>
            <select id="codexSort">
              <option value="az">A → Z</option>
              <option value="za">Z → A</option>
              <option value="home">Ordre Accueil</option>
              <option value="links">Nb. satellites</option>
            </select>
          </div>
        </aside>
        <div class="grid" id="codexGrid" aria-live="polite"></div>
      </section>
    </div>

    <aside class="rightPane fx-reveal">
      <div class="sideTitle">
        <span class="swatch" id="centerSwatch" style="background:var(--accent);color:var(--accent)"></span>
        <div>
          <div class="noteHead fx-swap" id="noteTitle">Aucune image sélectionnée</div>
          <div class="noteLabel fx-swap" id="noteSubtitle">Sélectionne une image au centre</div>
        </div>
      </div>
      <textarea id="noteTextarea" placeholder="Tes notes sur l’image centrale…"></textarea>
      <div class="btnRow">
        <button class="btn" id="saveNoteBtn">💾 Enregistrer</button>
        <button class="btn" id="clearNoteBtn">🧹 Effacer</button>
      </div>
      <div id="satList" class="satList"></div>
    </aside>
  </div>

  <!-- Paramètres -->
  <div id="settingsPanel" class="settingsPanel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" aria-hidden="true">
    <div class="settingsCard">
      <div class="settingsHead">
        <h2 id="settingsTitle">Paramètres</h2>
        <button id="closeSettings" class="iconBtn" title="Fermer">✖</button>
      </div>
      <div class="tabs">
        <button class="tabBtn active" data-tab="appearance">Apparence</button>
      </div>
      <div class="tabPanes">
        <section id="tab-appearance" class="tabPane active" aria-label="Apparence">
          <h3>Fond d’écran</h3>
          <p class="tabHint">Choisis un fond. Le thème s’harmonise automatiquement.</p>
          <div class="bgPicker" id="bgPicker" aria-label="Choisir l'image de fond floutée"></div>

          <h3 style="margin-top:14px">Harmonisation des tags</h3>
          <div class="rangeRow">
            <input type="range" id="tagHarmo" min="0" max="100" value="65" />
            <span id="tagHarmoVal">65%</span>
          </div>
          <p class="tabHint">0 % = couleurs fixes, 100 % = très influencées par le fond.</p>
        </section>
      </div>
    </div>
  </div>
  <div id="settingsOverlay" class="settingsOverlay" aria-hidden="true"></div>

  <!-- MODAL CODEX -->
  <div id="codexModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="codexModalTitle">
    <div class="modalCard">
      <div class="modalHead">
        <h3 id="codexModalTitle" style="margin:0"></h3>
        <button id="codexModalClose" class="iconBtn" title="Fermer">✖</button>
      </div>
      <div class="modalBody">
        <img id="codexModalImg" alt="aperçu" />
        <div>
          <p id="codexModalTip" class="tip"></p>
          <textarea id="codexModalNotes" placeholder="Tes notes (Codex, indépendantes de l’orbite)…"></textarea>
          <div class="btnRow"><button class="btn" id="codexModalSave">💾 Enregistrer</button></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======== Toutes tes fonctions d'origine (thème, helpers, CATALOG, etc.) ======== */
// ⚠️ Pour garder la réponse courte, j’ai compressé/retouché MINIMALEMENT la structure.
// Le bloc ci-dessous reprend tes utilitaires essentiels et le CATALOG tel quel.

function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min){h=s=0;}else{const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return{h,s,l}}
function hslToRgb(h,s,l){let r,g,b;if(s===0){r=g=b=l;}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};const q=l<.5?l*(1+s):l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)}}
function hex(rgb){const toHex=v=>v.toString(16).padStart(2,'0');return"#"+toHex(rgb.r)+toHex(rgb.g)+toHex(rgb.b)}
function contrastYIQ(r,g,b){return(r*299+g*587+b*114)/1000>=150?'#000':'#e9f7ff'}
function clamp(v,a,b){return Math.min(b,Math.max(a,v))}
function escapeHtml(str){return String(str).replace(/[&<>"']/g, ch => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch] || ch))}
var SAT_JITTER_DEG=22,RAD_JITTER=42,DELAY_JITTER=160;var SAT_JITTER_RAD=SAT_JITTER_DEG*Math.PI/180;function rand(min,max){return Math.random()*(max-min)+min}
var TAG_BASES={love:{h:300/360,s:.85,l:.56},important:{h:120/360,s:.75,l:.50},friend:{h:210/360,s:.80,l:.52},rival:{h:24/360,s:.90,l:.55},enemy:{h:0,s:.85,l:.55},unknown:{h:0,s:0,l:.45}};
function swapText(el,nextHTML){if(!el)return;el.classList.add('is-changing');var dur=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--fx-duration'))*1000||280;setTimeout(function(){el.innerHTML=nextHTML;el.classList.remove('is-changing')},dur)}
function runInitialReveals(){document.querySelectorAll('.fx-reveal').forEach(function(el,i){setTimeout(function(){el.classList.add('is-in')},40*i)})}
document.addEventListener('DOMContentLoaded',runInitialReveals);

var BG_LS_KEY="orbitBGIndexV1";var TAG_HARMO_KEY="orbitTagHarmoV1";var currentBgIndex=0;var tagHarmo=(function(){try{var v=parseInt(localStorage.getItem(TAG_HARMO_KEY),10);if(!Number.isNaN(v))return Math.min(100,Math.max(0,v));}catch(_){ } return 65;})();
var bgEl=document.getElementById("bg");var bgPickerEl=document.getElementById("bgPicker");
var BACKGROUNDS=[
  {src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD1.png",thumb:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD1.png"},
  {src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD2.png",thumb:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD2.png"},
  {src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD3.jpeg",thumb:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD3.jpeg"},
  {src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD4.jpg",thumb:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD4.jpg"},
  {src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD5.jpg",thumb:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD5.jpg"},
  {src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD6.jpg",thumb:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/Fond/FD6.jpg"}
];
function extractDominantColor(img){try{var c=document.createElement('canvas');var ctx=c.getContext('2d');var w=64,h=64;c.width=w;c.height=h;ctx.drawImage(img,0,0,w,h);var r=0,g=0,b=0,count=0;var data=ctx.getImageData(0,0,w,h).data;for(var i=0;i<data.length;i+=4){var R=data[i],G=data[i+1],B=data[i+2],A=data[i+3];if(A<120)continue;var lum=(R+G+B)/3;if(lum<20||lum>245)continue;r+=R;g+=G;b+=B;count++}if(!count){return{r:72,g:202,b:228}}return{r:Math.round(r/count),g:Math.round(g/count),b:Math.round(b/count)}}catch(e){return{r:72,g:202,b:228}}}
function applyThemeFromImage(img){var base=extractDominantColor(img);var baseHSL=rgbToHsl(base.r,base.g,base.b);var accent=hex(base);var accent2=hex(hslToRgb((baseHSL.h+.02)%1,Math.min(1,baseHSL.s+.1),Math.max(0,baseHSL.l-.08)));var accent3=hex(hslToRgb(baseHSL.h,Math.max(.25,baseHSL.s*.6),Math.min(.95,baseHSL.l+.25)));var paneRGB=hslToRgb(baseHSL.h,Math.min(.45,baseHSL.s*.5),Math.max(.10,baseHSL.l*.25));var pane2RGB=hslToRgb(baseHSL.h,Math.min(.35,baseHSL.s*.4),Math.max(.07,baseHSL.l*.18));var border='rgba('+base.r+', '+base.g+', '+base.b+', .28)';var glow='rgba('+base.r+', '+base.g+', '+base.b+', .65)';var text=contrastYIQ(paneRGB.r,paneRGB.g,paneRGB.b);var textDim= text==="#000"?"rgba(0,0,0,.7)":"rgba(233,247,255,.8)";var root=document.documentElement.style;root.setProperty('--accent',accent);root.setProperty('--accent-2',accent2);root.setProperty('--accent-3',accent3);root.setProperty('--pane','#'+((1<<24)+(paneRGB.r<<16)+(paneRGB.g<<8)+paneRGB.b).toString(16).slice(1));root.setProperty('--pane-2','#'+((1<<24)+(pane2RGB.r<<16)+(pane2RGB.g<<8)+pane2RGB.b).toString(16).slice(1));root.setProperty('--border',border);root.setProperty('--glow',glow);root.setProperty('--text',text);root.setProperty('--text-dim',textDim);var pane3RGB=hslToRgb(baseHSL.h,Math.min(.40,baseHSL.s*.45),Math.max(.06,baseHSL.l*.15));root.setProperty('--pane-3','#'+((1<<24)+(pane3RGB.r<<16)+(pane3RGB.g<<8)+pane3RGB.b).toString(16).slice(1));(function(){var isLightBG=(text==='#000');var strength=(tagHarmo||0)/100;var sScale=1+strength*(0.35+0.65*(0.35+baseHSL.s));var lBias=strength*((isLightBG?-0.18:+0.20)+(baseHSL.l-0.5)*0.35);function themedTag(base,fixed){if(fixed)return hex(hslToRgb(base.h,base.s,base.l));var h=base.h;var s=clamp(base.s*sScale,0.30,0.95);var l=clamp(base.l+lBias,0.28,0.78);return hex(hslToRgb(h,s,l))}root.setProperty('--tag-love',themedTag(TAG_BASES.love));root.setProperty('--tag-important',themedTag(TAG_BASES.important));root.setProperty('--tag-friend',themedTag(TAG_BASES.friend));root.setProperty('--tag-rival',themedTag(TAG_BASES.rival));root.setProperty('--tag-enemy',themedTag(TAG_BASES.enemy));root.setProperty('--tag-unknown',themedTag(TAG_BASES.unknown,true));})();}
function setBackground(index,options){options=options||{};var save=(typeof options.save==='boolean')?options.save:true;index=Math.max(0,Math.min(index,BACKGROUNDS.length-1));currentBgIndex=index;var url=BACKGROUNDS[index].src;var img=new Image();img.crossOrigin='anonymous';img.onload=function(){applyThemeFromImage(img);document.body.classList.add("has-bg");bgEl.classList.add("is-fading");requestAnimationFrame(function(){setTimeout(function(){bgEl.style.backgroundImage="url('"+url+"')";bgEl.classList.remove("is-fading");},180);});};img.onerror=function(){document.body.classList.add("has-bg")};img.src=url;Array.prototype.slice.call(bgPickerEl.children).forEach(function(el,i){el.classList.toggle("active",i===index)});if(save){try{localStorage.setItem(BG_LS_KEY,String(index));}catch(_){}}}
function buildBgPicker(){bgPickerEl.innerHTML="";BACKGROUNDS.forEach(function(item,i){var wrap=document.createElement("button");wrap.type="button";wrap.className="bgThumb";wrap.setAttribute("aria-label","Choisir le fond "+(i+1));wrap.onclick=function(){setBackground(i)};var img=document.createElement("img");img.src=item.thumb;img.alt="Miniature fond "+(i+1);wrap.appendChild(img);bgPickerEl.appendChild(wrap)})}
buildBgPicker();var initialIndex=0;try{var saved=parseInt(localStorage.getItem(BG_LS_KEY),10);if(!Number.isNaN(saved))initialIndex=Math.max(0,Math.min(saved,BACKGROUNDS.length-1));}catch(_){ } setBackground(initialIndex,{save:false});
var harmoInput=document.getElementById('tagHarmo');var harmoVal=document.getElementById('tagHarmoVal');if(harmoInput){harmoInput.value=String(tagHarmo);if(harmoVal)harmoVal.textContent=tagHarmo+'%';harmoInput.addEventListener('input',function(){tagHarmo=parseInt(harmoInput.value,10)||0;if(harmoVal)harmoVal.textContent=tagHarmo+'%';try{localStorage.setItem(TAG_HARMO_KEY,String(tagHarmo));}catch(_){ } setBackground(currentBgIndex,{save:false})})}

const CATALOG={
  Stella:{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Stella.jpg",tip:"La où tout a commencé",satellites:[{name:"Alter",tag:"???"},{name:"Syr",tag:"???"},{name:"???",tag:"Important"}],showOnHome:true,order:5},
  "Les Archives":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Archives.jpg",tip:"Pour aller au-dela",satellites:[{name:"Syr",tag:"Important"},{name:"Swan",tag:"???"},{name:"Zod",tag:"???"},{name:"Miyabi",tag:"???"},{name:"Huohuo",tag:"???"},{name:"Gerudo",tag:"???"}],showOnHome:true},
  Ichirin:{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Ichirin.jpg",tip:"Première âme de cette univers",satellites:[{name:"Elis",tag:"Amours"},{name:"Vyakarana",tag:"Ami"},{name:"Syr",tag:"Important"}],showOnHome:true},
  Alter:{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Univers%20Simul%C3%A9.jpg",tip:"Pour accomplir sa mission, il brisa sa conscience pour couvrir l'infinité de l'Univers",satellites:[{name:"Syr",tag:"Amours"},{name:"Vyakarana",tag:"Ami"},{name:"Swan",tag:"Ami"},{name:"???",tag:"Important"}],showOnHome:false},
  "Le Vyakarana":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Le%20Vyakarana.jpg",tip:"Une planète",satellites:[{name:"Vyakarana",tag:"Important"},{name:"Apôtre du Vyakarana",tag:"Ami"}],showOnHome:true},
  "???":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Stella.jpg",tip:"???",satellites:[{name:"Alter",tag:"Ami"},{name:"Syr",tag:"???"},{name:"Miku",tag:"Amours"},{name:"Stella",tag:"Important"}]},
  "Syr":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Syr.jpg",tip:"La 3ème existance d'Exis",satellites:[{name:"Alter",tag:"Amours"},{name:"Swan",tag:"Important"},{name:"Vyakarana",tag:"Ami"}]},
  "Vyakarana":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Vyakarana.jpg",tip:"Un semi être d'Exis purgeant l'univers des troubles de son créateur",satellites:[{name:"Alter",tag:"Amours"},{name:"Swan",tag:"Rival"},{name:"Le Vyakarana",tag:"Ennemie"}]},
  "Qingyi":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Qingyi.jpg",tip:"Une apotre du Vykarana cherchant à aider toutes les âmes égarer",satellites:[{name:"Yuu",tag:"Amours"},{name:"Sanzang",tag:"Ami"},{name:"Le Vyakarana",tag:"Important"}]},
  "Swan":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Swan.png",tip:"Une apotre du Vykarana cherchant à aider toutes les âmes égarer",satellites:[{name:"Yuu",tag:"Amours"},{name:"Sanzang",tag:"Ami"},{name:"Le Vyakarana",tag:"Important"}]},
  "Yuu":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Yuu.jpg",tip:"Une apotre du Vykarana cherchant à aider toutes les âmes égarer",satellites:[{name:"Herta",tag:"Important"},{name:"Huohuo",tag:"Amours"},{name:"Qingque",tag:"Ami"},{name:"Bailu",tag:"Ami"},{name:"Sparkle",tag:"Important"},{name:"Fu xuan",tag:"Important"}]},
  "Herta":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Herta.png",tip:"Une apotre du Vykarana cherchant à aider toutes les âmes égarer",satellites:[{name:"Yuu",tag:"Amours"},{name:"Sylvie",tag:"Important"},{name:"Huohuo",tag:"Important"},{name:"Fu xuan",tag:"Rival"}]},
  "Elis":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Elis.png",tip:"Une apotre du Vykarana cherchant à aider toutes les âmes égarer",satellites:[{name:"Hinako",tag:"Amours"},{name:"Sylvie",tag:"Important"},{name:"Huohuo",tag:"Important"},{name:"Fu xuan",tag:"Rival"}]},
  "La fin":{src:"https://raw.githubusercontent.com/Syruaih/Stella/refs/heads/main/images/Vyakarana.jpg",tip:"Un semi être d'Exis purgeant l'univers des troubles de son créateur",satellites:[]}
};
function hasNode(n){return !!CATALOG[n]} function getAllNames(){return Object.keys(CATALOG).sort((a,b)=>a.localeCompare(b,'fr'))}
function getSrc(n){return(CATALOG[n]&&CATALOG[n].src)||""} function getTip(n){return(CATALOG[n]&&CATALOG[n].tip)||("Tu explores « "+n+" » et ses satellites.")}
function getSatellites(n){var arr=(CATALOG[n]&&CATALOG[n].satellites)||[];return arr.map(s=>s.name).filter(hasNode)}
function getTag(center,sat){var list=(CATALOG[center]&&CATALOG[center].satellites)||[];for(var i=0;i<list.length;i++){if(list[i].name===sat) return list[i].tag||null}return null}
function isSatellite(n){var names=getAllNames();for(var i=0;i<names.length;i++){var sats=(CATALOG[names[i]]&&CATALOG[names[i]].satellites)||[];for(var j=0;j<sats.length;j++){if(sats[j].name===n) return true}}return false}
function getRootNames(){return getAllNames().filter(n=>!isSatellite(n))}
function getHomeNames(){var chosen=getAllNames().filter(n=>CATALOG[n]&&CATALOG[n].showOnHome===true);if(chosen.length){chosen.sort(function(a,b){var oa=(CATALOG[a].order||0),ob=(CATALOG[b].order||0);if(oa!==ob) return oa-ob;return a.localeCompare(b,'fr')});return chosen}return getRootNames()}
function colorForTag(tag){var map={"Amours":"--tag-love","Important":"--tag-important","Ami":"--tag-friend","Rival":"--tag-rival","Ennemie":"--tag-enemy","???":"--tag-unknown","ami":"--tag-friend","neutre":"--tag-important","dangereux":"--tag-enemy","ionique":"--tag-love","mystique":"--tag-rival"};var key=(tag||"").trim();var varName=map.hasOwnProperty(key)?map[key]:(map[key.toLowerCase()]||null);return 'var('+(varName||'--accent')+')'}
var DEFAULT_LINE_COLOR="var(--accent)";
var LS_KEY_CENTER="orbitNotesV1", LS_KEY_EDGES="orbitEdgeNotesV1", LS_KEY_LEFT_NOTE_MAP="orbitLeftNotesByCenterV1";
var notes=loadJSON(LS_KEY_CENTER,{}), edgeNotes=loadJSON(LS_KEY_EDGES,{}), leftNotesByCenter=loadJSON(LS_KEY_LEFT_NOTE_MAP,{});
var CENTER_SIZE=180, SAT_SIZE=120, RADIUS=300;
var noteTitle=document.getElementById('noteTitle');var noteSubtitle=document.getElementById('noteSubtitle');var noteTextarea=document.getElementById('noteTextarea');var centerSwatch=document.getElementById('centerSwatch');var leftNoteEl=document.getElementById('leftNote');var leftNoteSave=document.getElementById('leftNoteSave');var leftNoteClear=document.getElementById('leftNoteClear');var satListEl=document.getElementById('satList');var debounceTimer=null;
var topTitleEl=document.getElementById('topTitle');function setTopTitle(name){ swapText(topTitleEl,(name||"Aucune image sélectionnée"))}
function setTopTip(text){var el=document.getElementById("topTip");swapText(el,text||"Clique un centre pour voir ses satellites...")}

/* ===== ROUTAGE SIMPLE: Orbite <-> Codex ===== */
const views={orbit:document.getElementById('view-orbit'), codex:document.getElementById('view-codex')};
const tabs={orbit:document.getElementById('tab-orbit'), codex:document.getElementById('tab-codex')};
function setView(name){Object.keys(views).forEach(v=>{const active=(v===name); if(v==='orbit'){views[v].style.display=active?'flex':'none'} else {views[v].classList.toggle('active',active); views[v].setAttribute('aria-hidden', String(!active));} tabs[v].setAttribute('aria-selected', String(active));});
  // Texte d'aide selon la vue
  if(name==='codex'){ setTopTitle('Codex'); setTopTip("Parcours, filtre et annote chaque entrée."); (function(){var sw=document.getElementById('searchWrap'); if(sw) sw.style.visibility='hidden';})(); }
  else { setTopTip(); (function(){var sw=document.getElementById('searchWrap'); if(sw) sw.style.visibility='visible';})(); }
  location.hash = '#'+name;
}
['orbit','codex'].forEach(v=>tabs[v].addEventListener('click',()=>setView(v)));
window.addEventListener('hashchange',()=>{const h=(location.hash||'').replace('#',''); setView(h==='codex'?'codex':'orbit')});

/* ====== ORBITE (logique d'origine, conservée) ====== */
var listEl=document.getElementById('imgList');var searchForm=document.getElementById('searchForm');var searchInput=document.getElementById('imgSearch');
var SEARCH_SUGGEST_LIMIT=6;
function rebuildImageList(query){query=(query||"").trim().toLowerCase();var names=getAllNames();var scored=names.map(function(n){var ln=n.toLowerCase();var score=3;if(!query)score=3; else if(ln.startsWith(query))score=1; else if(ln.indexOf(query)>-1)score=2;return{n:n,score:score}}).sort(function(a,b){return(a.score-b.score)||a.n.localeCompare(b.n,'fr')});listEl.innerHTML=scored.slice(0,SEARCH_SUGGEST_LIMIT).map(function(s){return '<option value="'+s.n+'">'}).join('');}
function executeSearch(){var q=(searchInput.value||'').trim();if(!q)return;var names=getAllNames();var exact=names.find(n=>n.toLowerCase()===q.toLowerCase());var partial=exact||names.find(n=>n.toLowerCase().indexOf(q.toLowerCase())>-1);if(partial){setView('orbit'); showOrbit(partial); searchInput.blur();}else{searchInput.setCustomValidity("Aucune image trouvée");searchInput.reportValidity();setTimeout(()=>searchInput.setCustomValidity(""),1200);} }
if(searchInput){searchInput.addEventListener('input',function(){rebuildImageList(searchInput.value)});searchInput.addEventListener('change',executeSearch);searchInput.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();executeSearch();}});} if(searchForm){searchForm.addEventListener('submit',function(e){e.preventDefault();executeSearch();});}
rebuildImageList("");

/* ===== Notes overlay gauche ===== */
function getActiveLeftKey(){return currentCenterName()||"__GLOBAL__"}
function loadLeftNoteForCurrent(){var key=getActiveLeftKey(); leftNoteEl.value=leftNotesByCenter[key]||""; leftNoteEl.placeholder= key==="__GLOBAL__" ? "Notes (globales)…" : "Notes pour « "+key+" »…";}
function saveLeftNoteForCurrent(){var key=getActiveLeftKey(); leftNotesByCenter[key]=leftNoteEl.value||""; saveJSON(LS_KEY_LEFT_NOTE_MAP,leftNotesByCenter);} 
function clearLeftNoteForCurrent(){var key=getActiveLeftKey(); leftNotesByCenter[key]=""; saveJSON(LS_KEY_LEFT_NOTE_MAP,leftNotesByCenter); leftNoteEl.value="";}
leftNoteSave.onclick=function(){saveLeftNoteForCurrent(); pulse(leftNoteEl);};
leftNoteClear.onclick=function(){clearLeftNoteForCurrent();};
leftNoteEl.addEventListener('input',function(){clearTimeout(debounceTimer);debounceTimer=setTimeout(saveLeftNoteForCurrent,400)});
leftNoteEl.addEventListener('blur',saveLeftNoteForCurrent);
leftNoteEl.addEventListener('keydown',function(e){if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){e.preventDefault();saveLeftNoteForCurrent();pulse(leftNoteEl);}});

/* ===== Notes panneau droit ===== */
var saveBtnEl=document.getElementById('saveNoteBtn');var clearBtnEl=document.getElementById('clearNoteBtn');
saveBtnEl.onclick=function(){var n=currentCenterName(); if(!n)return; notes[n]=noteTextarea.value||""; saveJSON(LS_KEY_CENTER,notes); pulse(centerSwatch);};
clearBtnEl.onclick=function(){noteTextarea.value="";};

/* ===== Galerie ===== */
var mainGallery=document.getElementById('mainGallery');
function renderMainGallery(){mainGallery.innerHTML="";getHomeNames().filter(function(name){return !!getSrc(name)}).forEach(function(name){var card=document.createElement('div');card.className='card';var img=document.createElement('img');img.src=getSrc(name);img.alt=name;img.onclick=function(){setView('orbit'); showOrbit(name);};var label=document.createElement('div');label.className='label';label.textContent=name;card.appendChild(img);card.appendChild(label);mainGallery.appendChild(card);});}
renderMainGallery();

function waitForNonZeroSize(el,cb,tries){tries=tries||0;var w=el.clientWidth,h=el.clientHeight;if(w>0&&h>0){cb();return;}if(tries>10){cb();return;}setTimeout(function(){waitForNonZeroSize(el,cb,tries+1)},15)}

/* ===== Historique & boutons locaux ===== */
var navHistory=[]; const HOME_SENTINEL='__HOME__';
var stageBtns=document.getElementById('stageBtns'); var stepBackBtn=document.getElementById('stepBackBtn'); var homeBtn=document.getElementById('homeBtn');
function updateStageButtonsVisibility(){var orbit=document.getElementById('orbitContainer');var inOrbit=orbit&&orbit.classList.contains('active'); if(stageBtns) stageBtns.style.display=inOrbit?'flex':'none'; if(stepBackBtn) stepBackBtn.style.display=(inOrbit && navHistory.length>0)?'inline-block':'none';}
if(stepBackBtn){stepBackBtn.addEventListener('click',function(e){e.stopPropagation(); var prev=navHistory.pop(); if(prev===HOME_SENTINEL){backToMain();} else if(prev){showOrbit(prev);} else {backToMain();} updateStageButtonsVisibility();});}
if(homeBtn){homeBtn.addEventListener('click',function(e){e.stopPropagation(); backToMain();});}

/* ===== Scène orbitale ===== */
var centerWrap=document.getElementById('orbitCenterWrap'); var centerA=document.getElementById('orbitCenterA'); var centerB=document.getElementById('orbitCenterB'); var centerActive=centerA; var centerHidden=centerB;
function setCenterImageSmooth(url,name){return new Promise(function(resolve){var img=new Image();img.crossOrigin='anonymous';img.onload=function(){centerHidden.src=url; centerHidden.alt=name||'Centre'; if(centerWrap&&centerWrap.dataset){centerWrap.dataset.name=name||'';} centerWrap.classList.add('is-swapping'); centerHidden.classList.remove('is-hidden'); centerActive.classList.add('is-hidden'); var onEnd=function(){centerWrap.classList.remove('is-swapping'); centerActive.removeEventListener('transitionend',onEnd); var tmp=centerActive; centerActive=centerHidden; centerHidden=tmp; resolve();}; centerActive.addEventListener('transitionend',onEnd,{once:true});}; img.src=url;});}
function currentCenterName(){return (centerWrap&&centerWrap.dataset&&centerWrap.dataset.name)?centerWrap.dataset.name:""}

function setTopTitleSafe(name){ setTopTitle(name||"Aucune image sélectionnée"); }
function setTopTipSafe(text){ setTopTip(text||"Clique un centre pour voir ses satellites..."); }

function showOrbit(centerName,opts){opts=opts||{}; var main=document.getElementById('mainGallery'); var orbit=document.getElementById('orbitContainer'); if(!hasNode(centerName)||!getSrc(centerName)) return;
  swapText(noteTitle,centerName); swapText(noteSubtitle,"Tes notes pour cette image :"); noteTextarea.value=notes[centerName]||""; setTopTitleSafe(centerName); setTopTipSafe(getTip(centerName));
  var satsData=CATALOG[centerName].satellites||[]; var firstTag=(satsData[0]&&satsData[0].tag)||null; var c=colorForTag(firstTag); centerSwatch.style.background=c; centerSwatch.style.color=c;
  var fromEl=opts.smoothFromEl||null;
  if(fromEl){var prevVis=fromEl.style.visibility; fromEl.style.visibility='hidden'; orbit.classList.add('hide-edges'); setTimeout(function(){clearOrbit();},140); setCenterImageSmooth(getSrc(centerName),centerName).then(function(){requestAnimationFrame(function(){var satellites=getSatellites(centerName); renderSatelliteList(centerName,satellites); createOrbitItems(centerName,satellites); requestAnimationFrame(function(){orbit.classList.remove('hide-edges');}); fromEl.style.visibility=prevVis; updateStageButtonsVisibility();});}); main.classList.add('is-fading'); loadLeftNoteForCurrent(); return; }
  main.classList.add('is-fading'); orbit.classList.add('active'); orbit.classList.remove('is-visible'); orbit.style.visibility='hidden';
  setCenterImageSmooth(getSrc(centerName),centerName).then(function(){requestAnimationFrame(function(){orbit.style.visibility='visible'; orbit.classList.add('is-visible'); updateStageButtonsVisibility();});});
  requestAnimationFrame(function(){void orbit.offsetWidth; requestAnimationFrame(function(){waitForNonZeroSize(orbit,function(){var satellites=getSatellites(centerName); renderSatelliteList(centerName,satellites); createOrbitItems(centerName,satellites);});});});
  loadLeftNoteForCurrent();
}

function renderSatelliteList(centerName,satelliteNames){ if(!satListEl)return; if(!satelliteNames.length){ satListEl.innerHTML='<div style="opacity:.7">— Aucun —</div>'; return; } satListEl.innerHTML=''; for(var i=0;i<satelliteNames.length;i++){var sat=satelliteNames[i]; var tag=getTag(centerName,sat); var color=colorForTag(tag); var item=document.createElement('div'); item.className='satItem'; var left=document.createElement('div'); left.className='satLeft'; var dot=document.createElement('span'); dot.className='dot'; dot.style.background=color; dot.style.color=color; var nameEl=document.createElement('span'); nameEl.className='satName'; nameEl.textContent=sat; var tagEl=document.createElement('span'); tagEl.className='satTag'; tagEl.textContent= tag ? '('+tag+')' : '(défaut)'; left.appendChild(dot); left.appendChild(nameEl); left.appendChild(tagEl); item.appendChild(left); satListEl.appendChild(item);} }

function clearOrbit(){ Array.prototype.forEach.call(document.querySelectorAll('.orbit-item'),function(n){n.remove()}); document.getElementById('lineLayer').innerHTML=""; Popover.close(); }

function createOrbitItems(centerName,satelliteNames){ var orbit=document.getElementById('orbitContainer'); var lineLayer=document.getElementById('lineLayer'); clearOrbit(); var ow=orbit.clientWidth, oh=orbit.clientHeight; if(!ow||!oh) return waitForNonZeroSize(orbit,function(){createOrbitItems(centerName,satelliteNames)}); var cx=ow/2, cy=oh/2;
  satelliteNames.forEach(function(satName,index){ var src=getSrc(satName); var tag=getTag(centerName,satName); var color=colorForTag(tag);
    var img=document.createElement('img'); img.src=src; img.alt=satName; img.setAttribute('data-name',satName); img.className='orbit-item'; img.style.width=SAT_SIZE+'px'; img.style.height=SAT_SIZE+'px'; img.style.border='3px solid '+color; img.style.boxShadow='0 0 48px '+color+', 0 0 24px '+color; orbit.appendChild(img);
    img.style.left=(cx - SAT_SIZE/2)+'px'; img.style.top=(cy - SAT_SIZE/2)+'px';
    var baseAngle=(index/Math.max(1,satelliteNames.length))*2*Math.PI; var angle=baseAngle + (Math.random()*2-1)*SAT_JITTER_RAD; var radius=RADIUS + (Math.random()*2-1)*RAD_JITTER;
    var tx=cx + Math.cos(angle)*radius - SAT_SIZE/2; var ty=cy + Math.sin(angle)*radius - SAT_SIZE/2;
    var line=createConnector(lineLayer,cx,cy,tx + SAT_SIZE/2, ty + SAT_SIZE/2, color);
    var baseDelay=80 + index*120 + Math.floor(Math.random()*DELAY_JITTER);
    setTimeout(function(){ img.style.left=tx+'px'; img.style.top=ty+'px'; img.style.opacity=1; requestAnimationFrame(function(){ extendConnector(line); }); }, baseDelay);
    img.addEventListener('click',function(e){ e.stopPropagation(); var center={x:cx,y:cy}; Popover.open({ orbitEl:orbit, anchorEl:img, center:center, color:color, title: POP_COPY.title(centerName,satName), getValue:function(){return (edgeNotes[centerName]&&edgeNotes[centerName][satName])?edgeNotes[centerName][satName]:"";}, onSave:function(val){ if(!edgeNotes[centerName]) edgeNotes[centerName]={}; edgeNotes[centerName][satName]=val; saveJSON(LS_KEY_EDGES,edgeNotes); }, onSetCenter:function(){ var prev=currentCenterName(); if(prev) navHistory.push(prev); else navHistory.push(HOME_SENTINEL); showOrbit(satName,{smoothFromEl:img}); updateStageButtonsVisibility(); }}); });
  });
  orbit.addEventListener('click',function(e){ if(e.target===orbit) Popover.close(); });
}
function createConnector(layer,x1,y1,x2,y2,color){var dx=x2-x1, dy=y2-y1; var length=Math.hypot(dx,dy); var angle=Math.atan2(dy,dx); var line=document.createElement('div'); line.className='connector'; line.style.width='0px'; line.style.left=x1+'px'; line.style.top=y1+'px'; line.style.transform='rotate('+angle+'rad)'; line.style.background=color; line.style.boxShadow='0 0 8px '+color; line.setAttribute('data-length',String(length)); layer.appendChild(line); void line.offsetWidth; return line;}
function extendConnector(line){ line.style.opacity=1; line.style.width=line.getAttribute('data-length')+'px'; }

function backToMain(){ clearOrbit(); var orbit=document.getElementById('orbitContainer'); orbit.classList.remove('is-visible'); orbit.classList.remove('active'); orbit.style.visibility='hidden'; var main=document.getElementById('mainGallery'); main.classList.remove('is-fading'); swapText(noteTitle,"Aucune image sélectionnée"); swapText(noteSubtitle,"Sélectionne une image au centre"); noteTextarea.value=""; setTopTitleSafe("Aucune image sélectionnée"); setTopTipSafe("Clique un centre pour voir ses satellites..."); centerSwatch.style.background="var(--accent)"; centerSwatch.style.color="var(--accent)"; satListEl.innerHTML='<div style="opacity:.7">— Aucun —</div>'; if(centerWrap&&centerWrap.dataset) centerWrap.dataset.name=""; loadLeftNoteForCurrent(); navHistory=[]; updateStageButtonsVisibility(); }

/* ===== Libellés Popover ===== */
const POP_COPY={ title:(center,sat)=>{var tag=getTag(center,sat); var name=escapeHtml(sat||""); if(tag){var safeTag=escapeHtml(tag); var color=colorForTag(tag); return `${name} <span style="color:${color}; font-weight:600">(${safeTag})</span>`;} return name;}, emptyNote:"(Aucune note pour ce lien)", placeholder:"Écris ta note…", setCenter:"Mettre au centre", edit:"Éditer", save:"Enregistrer" };
var POP_OFFSET_RADIAL=10, POP_OFFSET_SIDE=160;
var Popover=(function(){var current=null; var cleanup=function(){}; var lastPlace=function(){}; function open(opts){ close(); var orbitEl=opts.orbitEl, anchorEl=opts.anchorEl, center=opts.center; var color=opts.color, title=opts.title||'', getValue=opts.getValue, onSave=opts.onSave, onSetCenter=opts.onSetCenter; var pop=document.createElement('div'); pop.className='popover'; pop.setAttribute('role','dialog'); var titleHTML=opts.title||POP_COPY.title('Centre','Satellite'); var a11yText=(function(){var tmp=document.createElement('div'); tmp.innerHTML=titleHTML; return tmp.textContent||tmp.innerText||'';})(); pop.setAttribute('aria-label',a11yText); pop.setAttribute('data-state','hidden'); pop.style.borderColor=color; var initialVal=(getValue&&getValue())||''; var shownText= initialVal?escapeHtml(initialVal):escapeHtml(POP_COPY.emptyNote); pop.innerHTML='<div class="popTitle">'+titleHTML+'</div>'+'<div class="popText" data-el="text">'+shownText+'</div>'+'<textarea class="popEdit" data-el="edit" placeholder="'+escapeHtml(POP_COPY.placeholder)+'"></textarea>'+'<div class="popActions">'+'<button class="popBtn" data-el="setCenterBtn">'+escapeHtml(POP_COPY.setCenter)+'</button>'+'<button class="popBtn" data-el="editBtn">'+escapeHtml(POP_COPY.edit)+'</button>'+'<button class="popBtn" data-el="saveBtn">'+escapeHtml(POP_COPY.save)+'</button>'+'</div>';
    orbitEl.appendChild(pop); pop.addEventListener('click',function(e){e.stopPropagation();}); var text=pop.querySelector('[data-el="text"]'); var edit=pop.querySelector('[data-el="edit"]'); var editBtn=pop.querySelector('[data-el="editBtn"]'); var saveBtn=pop.querySelector('[data-el="saveBtn"]'); var setCenterBtn=pop.querySelector('[data-el="setCenterBtn"]');
    editBtn.addEventListener('click',function(){ edit.value=(getValue&&getValue())||''; text.style.display='none'; edit.style.display='block'; editBtn.style.display='none'; saveBtn.style.display='inline-block'; edit.focus(); });
    saveBtn.addEventListener('click',function(){ if(getComputedStyle(edit).display==='none'){ edit.value=(getValue&&getValue())||text.textContent||''; text.style.display='none'; edit.style.display='block'; edit.focus(); return; } var v=edit.value||''; if(onSave) onSave(v); text.textContent=v||POP_COPY.emptyNote; text.style.display='block'; edit.style.display='none'; editBtn.style.display='inline-block'; saveBtn.style.display='inline-block'; });
    setCenterBtn.addEventListener('click',function(){ if(onSetCenter) onSetCenter(); close(); });
    var place=function(){ placePopover({pop:pop,orbitEl:orbitEl,anchorEl:anchorEl,center:center}); }; lastPlace=place; place(); var aRect=anchorEl.getBoundingClientRect(), oRect=orbitEl.getBoundingClientRect(); var sx=aRect.left-oRect.left+aRect.width/2, sy=aRect.top-oRect.top+aRect.height/2; var start=fromVectorTo(pop,{x:sx,y:sy}); pop.style.setProperty('--from-x',start.x+'px'); pop.style.setProperty('--from-y',start.y+'px'); requestAnimationFrame(function(){ pop.setAttribute('data-state','shown'); });
    var onDocClick=function(e){ if(!pop.contains(e.target)) close(); }; var onKey=function(e){ if(e.key==='Escape') close(); if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ var sb=pop.querySelector('[data-el="saveBtn"]'); if(sb) sb.click(); } }; var ro=new ResizeObserver(place); ro.observe(orbitEl); ro.observe(pop); window.addEventListener('resize',place); document.addEventListener('click',onDocClick); document.addEventListener('keydown',onKey); cleanup=function(){document.removeEventListener('click',onDocClick);document.removeEventListener('keydown',onKey);window.removeEventListener('resize',place);try{ro.disconnect();}catch(_){}}; current=pop; }
  function fromVectorTo(pop,target){var pr=pop.getBoundingClientRect(); var o={x:pr.left+pr.width/2,y:pr.top+pr.height/2}; return {x:target.x-o.x,y:target.y-o.y}; }
  function placePopover(args){var pop=args.pop, orbitEl=args.orbitEl, anchorEl=args.anchorEl, center=args.center; var oRect=orbitEl.getBoundingClientRect(); var aRect=anchorEl.getBoundingClientRect(); var sx=aRect.left-oRect.left+aRect.width/2; var sy=aRect.top-oRect.top+aRect.height/2; var sign=(sx>=center.x)?+1:-1; var posX=sx + sign*(SAT_SIZE/2 + POP_OFFSET_SIDE + POP_OFFSET_RADIAL); var posY=sy; pop.style.left=posX+'px'; pop.style.top=posY+'px'; pop.style.transform='translate(-50%, -50%)'; var pRect=pop.getBoundingClientRect(); var vw=Math.max(document.documentElement.clientWidth,window.innerWidth||0); var vh=Math.max(document.documentElement.clientHeight,window.innerHeight||0); var overflowLeft=pRect.left<12; var overflowRight=pRect.right>vw-12; if(overflowLeft||overflowRight){ sign=-sign; posX=sx + sign*(SAT_SIZE/2 + POP_OFFSET_SIDE + POP_OFFSET_RADIAL); pop.style.left=posX+'px'; pRect=pop.getBoundingClientRect(); var clampedLeft=Math.min(Math.max(pRect.left,12),vw-pRect.width-12); var clampedTop=Math.min(Math.max(pRect.top,12),vh-pRect.height-12); if(clampedLeft!==pRect.left||clampedTop!==pRect.top){ var adjustedX=clampedLeft-oRect.left+pRect.width/2; var adjustedY=clampedTop -oRect.top +pRect.height/2; pop.style.left=adjustedX+'px'; pop.style.top=adjustedY+'px'; } } }
  function close(){ if(!current)return; var pop=current; current=null; cleanup(); pop.setAttribute('data-state','hidden'); setTimeout(function(){try{pop.remove();}catch(_){}} ,250); }
  return {open:open, close:close, reposition:function(){try{lastPlace();}catch(_){}}}; })();

/* ===== Utils ===== */
function loadJSON(k,fallback){var r=null;try{r=localStorage.getItem(k);}catch(e){r=null;} if(!r)return clone(fallback); try{return mergeObjects(clone(fallback),JSON.parse(r));}catch(e){return clone(fallback);} }
function saveJSON(k,o){try{localStorage.setItem(k,JSON.stringify(o));}catch(e){} }
function clone(obj){try{return JSON.parse(JSON.stringify(obj||{}));}catch(e){return {};} }
function mergeObjects(base,extra){if(!extra)return base;for(var key in extra){if(Object.prototype.hasOwnProperty.call(extra,key)){base[key]=extra[key];}}return base;}
function pulse(el){if(!el||!el.animate)return; el.animate([{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}],{duration:300});}
if(!Math.hypot){Math.hypot=function(x,y){return Math.sqrt(x*x+y*y)}}

/* ===== Paramètres ===== */
var settingsBtn=document.getElementById('openSettings');var settingsPanel=document.getElementById('settingsPanel');var settingsOverlay=document.getElementById('settingsOverlay');var closeSettingsBtn=document.getElementById('closeSettings');
function openSettings(){settingsPanel.setAttribute('aria-hidden','false');settingsOverlay.setAttribute('aria-hidden','false');settingsBtn.setAttribute('aria-expanded','true');}
function closeSettings(){settingsPanel.setAttribute('aria-hidden','true');settingsOverlay.setAttribute('aria-hidden','true');settingsBtn.setAttribute('aria-expanded','false');}
settingsBtn.addEventListener('click',openSettings); closeSettingsBtn.addEventListener('click',closeSettings); settingsOverlay.addEventListener('click',closeSettings); document.addEventListener('keydown',function(e){if(e.key==='Escape')closeSettings();});
Array.prototype.forEach.call(document.querySelectorAll('.tabBtn'),function(btn){ btn.addEventListener('click',function(){ var target=btn.dataset.tab; Array.prototype.forEach.call(document.querySelectorAll('.tabBtn'),function(b){b.classList.toggle('active',b===btn)}); Array.prototype.forEach.call(document.querySelectorAll('.tabPane'),function(p){p.classList.toggle('active',p.id==='tab-'+target)}); });});

/* ===== CODEX ===== */
const TAGS=['Amours','Important','Ami','Rival','Ennemie','???'];
const codexGrid=document.getElementById('codexGrid'); const codexSearch=document.getElementById('codexSearch'); const codexSort=document.getElementById('codexSort'); const tagChips=document.getElementById('tagChips'); const CODEX_NOTES_KEY='codexNotesV1'; let codexNotes=loadJSON(CODEX_NOTES_KEY,{}); let activeTags=new Set();
function buildTagChips(){ tagChips.innerHTML=''; TAGS.forEach(t=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=t; b.setAttribute('aria-pressed','false'); b.onclick=()=>{ const on=b.getAttribute('aria-pressed')==='true'; b.setAttribute('aria-pressed', String(!on)); on?activeTags.delete(t):activeTags.add(t); renderCodex(); }; tagChips.appendChild(b); }); }
function entries(){ return getAllNames().map(n=>({name:n, src:getSrc(n), tip:getTip(n), sats:getSatellites(n), tags:(CATALOG[n].satellites||[]).map(s=>s.tag).filter(Boolean)})).filter(e=>!!e.src); }
function renderCodex(){ const q=(codexSearch.value||'').trim().toLowerCase(); const sort=codexSort.value; let es=entries(); if(q) es=es.filter(e=>e.name.toLowerCase().includes(q)); if(activeTags.size) es=es.filter(e=> e.tags.some(t=>activeTags.has(t))); if(sort==='az') es.sort((a,b)=>a.name.localeCompare(b.name,'fr')); if(sort==='za') es.sort((a,b)=>b.name.localeCompare(a.name,'fr')); if(sort==='home'){ const order=new Map(getHomeNames().map((n,i)=>[n,i])); es.sort((a,b)=>(order.get(a.name)??1e6)-(order.get(b.name)??1e6)); } if(sort==='links') es.sort((a,b)=> b.sats.length - a.sats.length);
  codexGrid.innerHTML=''; es.forEach(e=>{ const card=document.createElement('article'); card.className='codexCard'; card.innerHTML=`<img class="thumb" src="${e.src}" alt="${e.name}"><div class="body"><h4>${e.name}</h4><div class="meta">${e.sats.length} satellite(s)</div><div class="tags">${Array.from(new Set(e.tags)).map(t=>`<span><span class="tagDot" style="background:${colorForTag(t)}"></span>${t}</span>`).join(' ')}</div><div class="actions"><button class="btn" data-open>Ouvrir</button><button class="btn" data-center>Mettre au centre</button></div></div>`; card.querySelector('[data-center]').onclick=()=>{ setView('orbit'); showOrbit(e.name); }; card.querySelector('[data-open]').onclick=()=>{ openCodexModal(e.name); }; codexGrid.appendChild(card); }); }
function openCodexModal(name){ const modal=document.getElementById('codexModal'); const tEl=document.getElementById('codexModalTitle'); const img=document.getElementById('codexModalImg'); const tip=document.getElementById('codexModalTip'); const notes=document.getElementById('codexModalNotes'); tEl.textContent=name; img.src=getSrc(name); tip.textContent=getTip(name); notes.value=codexNotes[name]||''; modal.setAttribute('aria-hidden','false'); }
function closeCodexModal(){ document.getElementById('codexModal').setAttribute('aria-hidden','true'); }
document.getElementById('codexModalClose').addEventListener('click', closeCodexModal);
document.getElementById('codexModalSave').addEventListener('click', function(){ const name=document.getElementById('codexModalTitle').textContent; const notes=document.getElementById('codexModalNotes').value||''; codexNotes[name]=notes; saveJSON(CODEX_NOTES_KEY,codexNotes); pulse(this); });

buildTagChips(); if(codexSearch){codexSearch.addEventListener('input', renderCodex);} if(codexSort){codexSort.addEventListener('change', renderCodex);} renderCodex();

/* ===== Initialisation ===== */
window.addEventListener('load', function(){ const initial=(location.hash||'').slice(1)==='codex'?'codex':'orbit'; setView(initial); });
/* ===== UX: fermer la modale via clic arrière-plan + Échap ===== */
document.getElementById('codexModal').addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'codexModal') closeCodexModal();
});
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') {
    var modal = document.getElementById('codexModal');
    if (modal && modal.getAttribute('aria-hidden') === 'false') closeCodexModal();
  }
});
/* Blur la recherche quand on passe à Codex */
if (typeof tabs!=='undefined' && tabs && tabs.codex) {
  tabs.codex.addEventListener('click', ()=>{
    if (typeof searchInput !== 'undefined' && searchInput) searchInput.blur();
  });
}
/* ===== UX: fermer la modale via clic arrière-plan + Échap ===== */
document.getElementById('codexModal').addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'codexModal') closeCodexModal();
});
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') {
    var modal = document.getElementById('codexModal');
    if (modal && modal.getAttribute('aria-hidden') === 'false') closeCodexModal();
  }
});
/* Blur la recherche quand on passe à Codex */
if (typeof tabs!=='undefined' && tabs && tabs.codex) {
  tabs.codex.addEventListener('click', ()=>{
    if (typeof searchInput !== 'undefined' && searchInput) searchInput.blur();
  });
}
</script>
</body>
</html>
